<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Analytics</title>
    <script src="bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="bootstrap.min.css">
</head>

<body>

<div class="sidebar">
    <h4>Hotel System</h4>
    <div id="role-menu"></div>
    <hr>
    <a href="#">Logged in as: <span id="usernameLabel"></span></a>
    <a href="#" onclick="logout()">Logout</a>
</div>

<div class="main-content">

    <h2 class="mt-3">ðŸ“Š Real-Time Analytics Dashboard</h2>
    <p>Live metrics powered by Kafka events</p>

    <div class="row mt-4">

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Total Orders Today</h5>
                <h3 id="totalOrdersToday">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Ready Orders</h5>
                <h3 id="ordersReady">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Pending Orders</h5>
                <h3 id="ordersPending">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Total Revenue Today</h5>
                <h3 id="totalRevenueToday">$0.00</h3>
            </div>
        </div>
    </div>

    <h3 class="mt-5">Real-Time Popular Items</h3>
    <p>Updated every 10 seconds based on Kafka ORDER_CREATED events</p>

    <div class="row mt-3">

        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>Most Ordered (Last 10 mins)</h5>
                <h3 id="mostOrderedLast10Min">Loading...</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>âš¡ Fastest Selling Category</h5>
                <h3 id="fastestCategory">Loading...</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>Trending Items Now</h5>
                <p id="trendingItems">Loading...</p>
            </div>
        </div>
    </div>

    <h3 class="mt-5">Real-Time Kitchen Load Monitor</h3>
    <p>Tracks chef workload using Kafka ORDER_ASSIGNED_CHEF events</p>

    <div class="row mt-3">

        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>Busiest Chef (15 min)</h5>
                <h3 id="busiestChef">Loading...</h3>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card p-3 shadow-sm">
                <h5>Chef Workload (Past 15 min)</h5>
                <pre id="chefLoadCounts">Loading...</pre>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="salesReportModal" tabindex="-1" aria-labelledby="salesReportLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salesReportLabel">Sales Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="salesReportContent">
                <p>Loading report...</p>
            </div>
        </div>
    </div>
</div>
<script>
const user = JSON.parse(localStorage.getItem("user"));
if (!user) {
    window.location.href = "login.html";
} else {
    document.getElementById("usernameLabel").innerText = user.username;
    buildRoleSidebar();
}

function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}

function buildRoleSidebar() {
    const container = document.getElementById("role-menu");
    let links = "";

    if (user.role === "CUSTOMER") {
        links += `<a href="browse-menu.html">Browse Menu</a>`;
        links += `<a href="orders.html">My Orders</a>`;
    }
    else if (user.role === "MANAGER") {
        links += `<a href="assign-chef.html">Assign Chef</a>`;
        links += `<a href="#" id="salesReportLink">View Sales Report</a>`;
        links += `<a href="analytics.html" class="active">Real-Time Analytics</a>`;
    }
    else if (user.role === "CHEF") {
        links += `<a href="chef-dashboard.html">Chef Dashboard</a>`;
    }

    container.innerHTML = links;

    if (user.role === "MANAGER") {
        const reportLink = document.getElementById("salesReportLink");
        if (reportLink) {
            reportLink.onclick = (e) => {
                e.preventDefault();
                showSalesReport();
            };
        }
    }
}

async function showSalesReport() {
    try {
        const response = await fetch(`/api/orders/report/sales`);
        const report = await response.json();

        let html = `
            <p><strong>Total Orders:</strong> ${report.totalOrders}</p>
            <p><strong>Total Revenue:</strong> $${report.totalRevenue.toFixed(2)}</p>
            <h6>Item Breakdown:</h6>
            <table class="table table-striped">
                <thead>
                    <tr><th>Item</th><th>Quantity Sold</th><th>Total Amount</th></tr>
                </thead>
                <tbody>
                    ${report.items.map(i => `
                        <tr>
                            <td>${i.itemName}</td>
                            <td>${i.quantitySold}</td>
                            <td>$${i.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `;

        document.getElementById("salesReportContent").innerHTML = html;
        new bootstrap.Modal(document.getElementById("salesReportModal")).show();

    } catch (err) {
        alert("Error loading report: " + err.message);
    }
}

function loadLiveAnalytics() {
    fetch("/api/analytics/live")
        .then(res => res.json())
        .then(data => {
            document.getElementById("totalOrdersToday").innerText = data.totalOrdersToday;
            document.getElementById("ordersReady").innerText = data.ordersReady;
            document.getElementById("ordersPending").innerText = data.ordersPending;
            document.getElementById("totalRevenueToday").innerText =
                "$" + data.totalRevenueToday.toFixed(2);
        });
}

function loadPopularItems() {
    fetch("/api/analytics/popular-items")
        .then(res => res.json())
        .then(data => {
            document.getElementById("mostOrderedLast10Min").innerText = data.mostOrderedLast10Min;
            document.getElementById("fastestCategory").innerText = data.fastestCategory;

            document.getElementById("trendingItems").innerText =
                data.trendingItem ? data.trendingItem : "No Trending Items";
        });
}

function loadKitchenLoad() {
    fetch("/api/analytics/kitchen-load")
        .then(res => res.json())
        .then(data => {

            document.getElementById("busiestChef").innerText =
                data.busiestChef === -1 ? "No Activity" : ("Chef #" + data.busiestChef);

            let loadText = "";
            Object.entries(data.chefLoads).forEach(([chef, list]) => {
                loadText += `Chef ${chef}: ${list.length} orders\n`;
            });

            document.getElementById("chefLoadCounts").innerText =
                loadText || "No chef activity in last 15 minutes";
        });
}

setInterval(loadLiveAnalytics, 2000);
setInterval(loadPopularItems, 10000);
setInterval(loadKitchenLoad, 8000);

loadLiveAnalytics();
loadPopularItems();
loadKitchenLoad();


</script>
</body>
</html>
