<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assign Chef to Orders</title>
    <script src="bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="bootstrap.min.css">
</head>
<body>

<div class="sidebar">
    <h4>Hotel System</h4>

    <div id="role-menu"></div>

    <hr>
    <a href="#">Logged in as: <span id="usernameLabel"></span></a>
    <a href="#" onclick="logout()">Logout</a>
</div>

<div class="main-content" id="main-content">
    <p>Loading your orders...</p>
</div>

<div class="modal fade" id="salesReportModal" tabindex="-1" aria-labelledby="salesReportLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salesReportLabel">Sales Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="salesReportContent">
                <p>Loading report...</p>
            </div>
        </div>
    </div>
</div>

<style>
    .order-card {
        background: #ffffff;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #e1e1e1;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .chef-select { margin-top: 10px; width: 250px; }
    .assign-btn { margin-top: 10px; }
</style>

<script>
const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
    window.location.href = "login.html";
} else if (user.role !== "MANAGER") {
    alert("Only managers can access this page.");
    window.location.href = "login.html";
}

document.getElementById("usernameLabel").textContent = user.username;

buildRoleSidebar();

function buildRoleSidebar() {
    const container = document.getElementById("role-menu");

    container.innerHTML = `
        <a href="assign-chef.html">Assign Chef</a>
        <a href="#" id="salesReportLink">View Sales Report</a>
        <a href="analytics.html">Real-Time Analytics</a>
    `;

    document.getElementById("salesReportLink").addEventListener("click", (e) => {
        e.preventDefault();
        showSalesReport();
    });
}

function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}

async function showSalesReport() {
    try {
        const response = await fetch(`/api/orders/report/sales`);
        if (!response.ok) throw new Error("Failed to fetch report.");

        const report = await response.json();

        let html = `
            <p><strong>Total Orders:</strong> ${report.totalOrders}</p>
            <p><strong>Total Revenue:</strong> $${report.totalRevenue.toFixed(2)}</p>
            <h6>Item Breakdown:</h6>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity Sold</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${report.items.map(item => `
                        <tr>
                            <td>${item.itemName}</td>
                            <td>${item.quantitySold}</td>
                            <td>$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `;

        document.getElementById("salesReportContent").innerHTML = html;
        new bootstrap.Modal(document.getElementById('salesReportModal')).show();

    } catch (err) {
        alert("Error: " + err.message);
    }
}

async function loadPendingOrders() {
    const response = await fetch("/api/orders");
    const orders = await response.json();

    window.currentOrders = orders;

    const container = document.getElementById("main-content");
    container.innerHTML = "";

    const pendingOrders = orders.filter(o => o.status === "OPEN");

    if (pendingOrders.length === 0) {
        container.innerHTML = "<p>No pending orders.</p>";
        return;
    }

    for (const order of pendingOrders) {
        const card = document.createElement("div");
        card.className = "order-card";

        const assigned = order.chefId !== null;

        card.innerHTML = `
            <h3>Order #${order.id}</h3>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Customer ID:</strong> ${order.customerId}</p>

            <label><strong>Assign Chef:</strong></label><br>
            <select id="chefSelect-${order.id}" class="form-select chef-select" ${assigned ? "disabled" : ""}>
                <option disabled selected>Loading chefs...</option>
            </select>

            ${!assigned ? `
                <button class="btn btn-primary assign-btn"
                    onclick="assignChef(${order.id})">
                    Assign
                </button>` : ""
            }
        `;

        container.appendChild(card);
        await populateChefsDropdown(order.id);
    }
}

async function populateChefsDropdown(orderId) {
    const response = await fetch("/api/users?role=CHEF");
    const chefs = await response.json();

    const select = document.getElementById(`chefSelect-${orderId}`);
    select.innerHTML = "";

    chefs.forEach(chef => {
        const option = document.createElement("option");
        option.value = chef.id;
        option.textContent = `${chef.username} (#${chef.id})`;
        select.appendChild(option);
    });

    const order = window.currentOrders.find(o => o.id === orderId);
    if (order && order.chefId) select.value = order.chefId;
}

async function assignChef(orderId) {
    const select = document.getElementById(`chefSelect-${orderId}`);
    const chefId = select.value;

    if (!chefId) {
        alert("Please select a chef.");
        return;
    }

    const response = await fetch(`/api/orders/${orderId}/assign-chef/${chefId}?managerId=${user.id}`, {
        method: "PUT"
    });

    if (response.ok) {
        alert("Chef assigned successfully.");
        loadPendingOrders();
    } else {
        const err = await response.text();
        alert("Error assigning chef: " + err);
    }
}

loadPendingOrders();
</script>
</body>
</html>
