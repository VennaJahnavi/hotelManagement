<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assign Chef to Orders</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <h2>Assign Chef to Orders</h2>
    <nav>
        <a href="home.html">Home</a> |
        <span id="user-info" style="margin-left: 15px; color: #555;"></span> |
        <a href="#" onclick="logout()">Logout</a>
    </nav>
</header>

<section id="orders-container">
    <p>Loading pending orders...</p>
</section>

<script>
    const user = JSON.parse(localStorage.getItem("user"));
    document.getElementById("user-info").textContent = `Logged in as: ${user.username}`;
    if (!user || user.role !== "MANAGER") {
        alert("Only managers can access this page.");
        window.location.href = "login.html";
    }

    async function logout() {
        sessionStorage.clear();
        window.location.href = "login.html";
    }

    async function loadPendingOrders() {
        const response = await fetch("/api/orders");
        const orders = await response.json();

        const container = document.getElementById("orders-container");
        container.innerHTML = "";

        const pendingOrders = orders.filter(order => order.status === "PENDING");

        if (pendingOrders.length === 0) {
            container.innerHTML = "<p>No pending orders.</p>";
            return;
        }

        for (const order of pendingOrders) {
            const card = document.createElement("div");
            card.className = "order-card";

            card.innerHTML = `
                <h3>Order #${order.id}</h3>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Customer ID:</strong> ${order.customerId}</p>
                <label for="chefSelect-${order.id}">Assign Chef:</label>
                <select id="chefSelect-${order.id}">
                    <option disabled selected>Loading chefs...</option>
                </select>
                <button onclick="assignChef(${order.id})">Assign</button>
            `;

            container.appendChild(card);

            await populateChefsDropdown(order.id);
        }
    }

    async function populateChefsDropdown(orderId) {
        const response = await fetch("/api/users?role=CHEF");
        const chefs = await response.json();

        const select = document.getElementById(`chefSelect-${orderId}`);
        select.innerHTML = ""; // Clear old options

        chefs.forEach(chef => {
            const option = document.createElement("option");
            option.value = chef.id;
            option.textContent = `${chef.username} (#${chef.id})`;
            select.appendChild(option);
        });
    }

    async function assignChef(orderId) {
        const select = document.getElementById(`chefSelect-${orderId}`);
        const chefId = select.value;

        if (!chefId) {
            alert("Please select a chef.");
            return;
        }

        const managerId = user.id;

        const response = await fetch(`/api/orders/${orderId}/assign-chef/${chefId}?managerId=${managerId}`, {
            method: "PUT"
        });

        if (response.ok) {
            alert("Chef assigned successfully.");
            loadPendingOrders(); // reload updated list
        } else {
            const error = await response.text();
            alert("Error assigning chef: " + error);
        }
    }

    loadPendingOrders();

</script>

<style>
    .order-card {
        background: #fff;
        margin: 20px auto;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    label, select, button {
        display: block;
        margin-top: 10px;
    }

    button {
        padding: 8px 12px;
        margin-top: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }

</style>

</body>
</html>
